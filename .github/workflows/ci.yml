name: Android CI

on:
  push:
    branches: [ main ]
    tags: [ v* ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    env:
      ANDROID_KEYSTORE_FILE: '${{ github.workspace }}/release-key.jks'
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: true
      CCACHE_MAXSIZE: 1G
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: 'recursive'
      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 21
          cache: 'gradle'
      - name: Retrieve version
        run: |
          if [ ${{ github.ref_type}} == "tag" ]; then
            echo VERSION=$(echo ${{ github.ref }} | sed -e 's/refs\/tags\/v//g')
            echo VERSION=$(echo ${{ github.ref }} | sed -e 's/refs\/tags\/v//g') >> $GITHUB_ENV
          else
            echo VERSION=$(echo ${{ github.event.head_commit.id }} | head -c 7)
            echo VERSION=$(echo ${{ github.event.head_commit.id }} | head -c 7) >> $GITHUB_ENV
          fi
          git fetch
          echo CODE=$(git rev-list --count origin/main) >> $GITHUB_ENV
      - name: Prepare for building
        run: |
          chmod +x gradlew
          base64 --decode <<< "${{ secrets.RELEASE_KEY }}" > "${{ env.ANDROID_KEYSTORE_FILE }}"
      - name: Setup Gradle & Build APK
        uses: gradle/gradle-build-action@v3
        with:
          gradle-home-cache-cleanup: true
          cache-overwrite-existing: true
          arguments: assembleRelease
        env:
          VERSION: ${{ env.VERSION }}
          CODE: ${{ env.CODE }}
          RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
          RELEASE_KEY_STORE_PASSWORD: ${{ secrets.RELEASE_KEY_STORE_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
      - name: Rename apk
        run: |
          python3 .ci/rename_apk.py
      - name: Upload built apk
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: apk
          path: |
            app/build/outputs/apk/release/*.apk
      - name: Upload signature
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: signature_v4
          path: |
            app/build/outputs/apk/release/*.idsig
      - name: Upload mappings
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: mappings
          path: app/build/outputs/mapping/release/
      - name: Setup Debug Session
        if: success() != true
        uses: mxschmitt/action-tmate@v3
        timeout-minutes: 15
      
